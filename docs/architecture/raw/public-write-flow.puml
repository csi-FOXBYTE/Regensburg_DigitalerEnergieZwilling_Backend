@startuml
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title Public Write Flow - Altcha + Server-Recompute

actor Citizen as user
participant "Public Client" as client
participant "Altcha Widget" as altcha
participant "APISIX (Web/API Gateway)" as gateway
participant "Backend API" as api
participant "Simulation Core (Server)" as sim
database "Database" as db

user -> client: Enters inputs
client -> altcha: Request challenge
altcha --> client: Challenge data
client -> altcha: Solve challenge
altcha --> client: Altcha token

client -> gateway: Submit inputs + results + config_version + Altcha token
gateway -> gateway: Rate limit check
gateway -> api: Forward request
api -> api: Validate input ranges (config)
api -> sim: Recompute with same core + config
sim --> api: Server results
api -> db: Store inputs + results
db --> api: Stored
api --> gateway: Accepted / Rejected
gateway --> client: Accepted / Rejected

note right of api
Only verified + triaged results
flow into BuildingIndex.
end note

@enduml

@startuml
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title Digitaler Energy Zwilling (DEZ) - C4 Container Diagram

Person(citizen, "Citizen (owners/landlords)")
Person(admin, "City Administration / Staff")

System_Boundary(civitas, "Civitas Core Platform") {
  System_Boundary(det, "Digitaler Energy Zwilling (DEZ)") {

    Container(gateway, "APISIX Web/API Gateway", "API Gateway and Reverse Proxy", "Single public entrypoint for frontend, backend APIs, config snapshots and tiles access")

    Container(frontend, "Web Frontend Static Site", "Astro SSG", "Static pages plus two interactive islands for public and admin")

    Container(backend, "Backend API", "Node.js and Fastify", "Auth, admin HTML delivery, APIs for config publish and user data triage")

    Container(simCore, "Simulation Core Module", "JavaScript Module Package", "Shared module, runs in browser and in Node")

    Container(tilesGw, "Tiles Gateway (optional)", "HTTP Gateway", "Optional proxy for 3D tiles with caching and range requests")
    Container(tilesStore, "3D Tiles Storage", "Object Storage", "3D tiles with solar (PV) attributes, textures, vegetation and geothermal attributes")

    ContainerDb(db, "Database", "PostgreSQL and PostGIS", "Stores user inputs, triage state and simulation configuration")
  }

  Container(idp, "Keycloak CIVITAS", "OIDC identity provider")
}
System_Ext(geo, "City Geo Services", "WMS and WMTS basemaps")

System_Ext(citygml, "CityGML LOD2 Source", "Input dataset")
System_Ext(potentials, "Solar (3D Tiles) and Geothermal Sources", "Solar 3D tiles + geothermal WMS/raster data")
System_Ext(vegetation, "Vegetation (Trees)", "3D tiles layer")

System_Boundary(pipeline, "Offline Data Pipeline") {
  Container(citygmlTools, "CityGML to CityJSON", "citygml-tools", "Converts CityGML to CityJSON")
  Container(gdal, "Geodata Processing", "GDAL + custom", "Joins geothermal WMS and solar tiles attributes; enriches buildings and roofs")
  Container(tilesConv, "CityJSON to 3D Tiles", "cityjson-to-3d-tiles", "Generates 3D tiles and embeds attributes")
}

Rel(citizen, gateway, "uses", "HTTPS")
Rel(admin, gateway, "uses", "HTTPS")

Rel(gateway, frontend, "routes public site", "GET /")
Rel(gateway, backend, "routes admin site and API", "GET /admin and /api")
Rel(gateway, tilesGw, "routes tiles (optional mode)", "GET /tiles")
Rel(gateway, tilesStore, "routes tiles (direct mode)", "GET /tiles")

Rel(admin, idp, "authenticates", "OIDC")
Rel(backend, idp, "validates tokens", "OIDC or JWT")

Rel(frontend, simCore, "imports and runs", "browser runtime")
Rel(backend, simCore, "imports and runs", "Node runtime optional")

Rel(frontend, geo, "loads basemaps", "WMS or WMTS")
Rel(frontend, gateway, "loads 3D tiles with embedded potentials", "GET /tiles")
Rel(tilesGw, tilesStore, "fetches tiles", "HTTP")

Rel(backend, db, "reads and writes", "SQL")
Rel(frontend, backend, "calls API for user data and admin actions", "REST")

Rel(citygml, citygmlTools, "feeds")
Rel(potentials, gdal, "feeds")
Rel(vegetation, gdal, "feeds")
Rel(citygmlTools, tilesConv, "outputs CityJSON")
Rel(gdal, tilesConv, "provides computed attributes")
Rel(tilesConv, tilesStore, "writes tiles with embedded potentials")

@enduml

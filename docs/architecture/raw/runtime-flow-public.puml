@startuml
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam sequence {
  ParticipantBorderColor #444444
  ParticipantBackgroundColor #F7F7F7
  LifeLineBorderColor #444444
  ArrowColor #444444
  NoteBorderColor #444444
  NoteBackgroundColor #F7F7F7
}

title Runtime-Flow - Buerger (Public)

actor Citizen as user
participant "Public Client" as client
participant "APISIX (Web/API Gateway)" as gateway
participant "Public Static Delivery" as public_static
participant "Tiles Gateway (optional)" as tiles
participant "Datendienst (S3)" as s3
participant "Simulation Core (Browser)" as sim
participant "Altcha Widget" as altcha
participant "Backend API" as api
database "Database" as db

user -> client: Oeffnet Anwendung
client -> gateway: GET /
gateway -> public_static: Lade HTML/Assets
public_static --> gateway: HTML/Assets
gateway --> client: HTML/Assets

client -> gateway: GET /config/versioned.json
gateway -> public_static: Lade Config Snapshot
public_static --> gateway: Config Snapshot
gateway --> client: Config Snapshot

alt Tiles direct mode
  client -> gateway: GET /tiles/*
  gateway -> s3: Read tiles
  s3 --> gateway: Tiles
  gateway --> client: Tiles
else Tiles via optional gateway
  client -> gateway: GET /tiles/*
  gateway -> tiles: Route tiles request
  tiles -> s3: Read tiles
  s3 --> tiles: Tiles
  tiles --> gateway: Tiles
  gateway --> client: Tiles
end

client -> sim: Simulation lokal ausfuehren

alt Config oder Tiles fehlen
  client --> user: Fehler anzeigen (Retry)
end

alt Optional: Ergebnisse uebermitteln
  client -> altcha: Request Challenge
  altcha --> client: Challenge
  client -> altcha: Solve Challenge
  altcha --> client: Token
  client -> gateway: POST /api/public/inputs + Token
  gateway -> gateway: Rate limit check
  gateway -> api: Forward request
  api -> sim: Server-Recompute
  sim --> api: Ergebnis
  api -> db: Store inputs/results
  db --> api: Stored
  api --> gateway: Accepted/Rejected
  gateway --> client: Accepted/Rejected

  alt Altcha oder Rate Limit fehlgeschlagen
    api --> gateway: Rejected (Validation)
    gateway --> client: Rejected (Validation)
  end

  alt Server-Recompute abweichend
    api --> gateway: Rejected (Mismatch)
    gateway --> client: Rejected (Mismatch)
  end
end

@enduml
